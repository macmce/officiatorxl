{% extends 'base.html' %}
{% load static %}

{% block title %}Meet Schedule - {{ meet.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
      <i class="fas fa-calendar-alt me-2"></i>Meet Schedule
    </h1>
    <div>
      <a href="{% url 'meet_detail' meet.id %}" class="btn btn-outline-secondary">
        <i class="fas fa-chevron-left me-1"></i>Back to Meet
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Meet Information only -->
    <div class="col-lg-6 col-xl-5 mb-4">
      <div class="card">
        <div class="card-header {% if meet.date < today %}bg-secondary text-white{% elif meet.date == today %}bg-primary text-white{% else %}bg-info text-white{% endif %}">
          <h5 class="mb-0">Meet Information</h5>
        </div>
        <div class="card-body">
          <p><strong>Name:</strong> {{ meet.name }}</p>
          <p><strong>Meet Type:</strong> {{ meet.get_meet_type_display }}</p>
          <p><strong>Host Team:</strong> {% if meet.host_team %}{{ meet.host_team.name }}{% else %}<span class="text-muted">Not specified</span>{% endif %}</p>
          <p><strong>Strategy:</strong> {{ meet.strategy|default:'-' }}</p>
          <p><strong>Meet Referee:</strong>
            {% if meet_referee %}
              {{ meet_referee.name }}
            {% else %}
              <span class="text-muted">Not selected</span>
            {% endif %}
          </p>
        </div>
      </div>

      <!-- Officials grouped by Certification -->
      <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-users me-2"></i>Officials</h5>
        </div>
        <div class="card-body p-0">
          {% if assignments %}
            {% regroup assignments by role as cert_groups %}
            <div class="accordion" id="officialsByCert">
              {% for group in cert_groups %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="cert-heading-{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cert-collapse-{{ forloop.counter }}" aria-expanded="false" aria-controls="cert-collapse-{{ forloop.counter }}">
                      <strong>{{ group.grouper|default:"(Unspecified Role)" }}</strong>
                      <span class="ms-2 badge bg-light text-dark">{{ group.list|length }}</span>
                    </button>
                  </h2>
                  <div id="cert-collapse-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="cert-heading-{{ forloop.counter }}" data-bs-parent="#officialsByCert">
                    <div class="accordion-body p-0">
                      <ul class="list-group list-group-flush">
                        {% for a in group.list %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ a.official.name }}</span>
                            <span class="small">
                              {% with p=a.official.proficiency %}
                                {% if p == 'Expert' %}
                                  <span class="badge bg-dark">{{ p }}</span>
                                {% elif p == 'Advanced' %}
                                  <span class="badge bg-primary">{{ p }}</span>
                                {% elif p == 'Intermediate' %}
                                  <span class="badge bg-info text-dark">{{ p }}</span>
                                {% elif p == 'Beginner' %}
                                  <span class="badge bg-secondary">{{ p }}</span>
                                {% else %}
                                  <span class="badge bg-light text-dark">{{ p|default:'Proficiency N/A' }}</span>
                                {% endif %}
                              {% endwith %}
                            </span>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="p-3">
              <div class="alert alert-info mb-0">No officials assigned yet.</div>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Pool -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-swimming-pool me-2"></i>Pool</h5>
        </div>
        <div class="card-body">
          {% if meet.pool %}
            <div class="row">
              <div class="col-12 col-md-6">
                <p class="mb-1"><strong>Name:</strong> {{ meet.pool.name }}</p>
                <p class="mb-1"><strong>Length:</strong> {{ meet.pool.length }} {{ meet.pool.units }}</p>
                <p class="mb-1"><strong>Lanes:</strong> {{ meet.pool.lanes }}</p>
                <p class="mb-1"><strong>Bidirectional:</strong> {% if meet.pool.bidirectional %}Yes{% else %}No{% endif %}</p>
              </div>
              <div class="col-12 col-md-6">
                <p class="mb-1"><strong>Team:</strong> {{ meet.pool.team.name }}</p>
                <p class="mb-1"><strong>Address:</strong>
                  {% if meet.pool.address %}
                    {{ meet.pool.address }}
                  {% else %}
                    <span class="text-muted">Not specified</span>
                  {% endif %}
                </p>
              </div>
            </div>
          {% else %}
            <div class="alert alert-warning mb-0">No pool selected for this meet.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Right column: Build it! and Positions -->
    <div class="col-lg-6 col-xl-7 mb-4">
      <!-- Build it! -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex align-items-center">
          <h5 class="mb-0"><i class="fas fa-hammer me-2"></i>Build it!</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'meet_build_schedule' meet.id %}">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Build option</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="build_option" id="buildLightest" value="LIGHTEST" checked>
                <label class="form-check-label" for="buildLightest">Lightest</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="build_option" id="buildHeaviest" value="HEAVIEST">
                <label class="form-check-label" for="buildHeaviest">Heaviest</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">
              Proceed
            </button>
          </form>
          {% if schedules %}
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Built Schedules</h6>
              <span class="badge bg-secondary">{{ schedules|length }}</span>
            </div>
            <div class="list-group">
              {% for s in schedules %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">{{ s.name }}</div>
                    <div class="text-muted small">
                      {{ s.created_at|date:"Y-m-d H:i:s" }} • Option: {{ s.get_build_option_display }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted small">No schedules built yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Positions list -->
      <div class="card">
        <div class="card-header bg-warning d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Positions</h5>
          <span class="small">Meet Type: {{ meet.get_meet_type_display }}{% if meet.strategy %} • Strategy: {{ meet.strategy.get_name_display|default:meet.strategy }}{% endif %}</span>
        </div>
        <div class="card-body p-0">
          {% if not meet.strategy %}
            <div class="p-3">
              <div class="alert alert-info mb-0">Set a Strategy for this meet to view positions.</div>
            </div>
          {% else %}
            {% if event_positions %}
              {% regroup event_positions by event as event_groups %}
              <div class="accordion" id="positionsByEvent">
                {% for group in event_groups %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ group.grouper.id }}">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ group.grouper.id }}" aria-expanded="false" aria-controls="collapse-{{ group.grouper.id }}">
                        <span class="me-2 badge bg-light text-dark">#{{ group.grouper.event_number }}</span>
                        <strong>{{ group.grouper.name }}</strong>
                      </button>
                    </h2>
                    <div id="collapse-{{ group.grouper.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ group.grouper.id }}" data-bs-parent="#positionsByEvent">
                      <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                          {% for ep in group.list %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                <div class="fw-semibold">{{ ep.position.role }}</div>
                                <div class="small text-muted">{{ ep.position.location|default:'-' }}</div>
                              </div>
                              <div class="text-end small">
                                <div>
                                  {% if ep.is_mandatory %}
                                    <span class="badge bg-success">Mandatory</span>
                                  {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                  {% endif %}
                                </div>
                                <div>
                                  {% if ep.position.minimum_certification %}
                                    Min: {{ ep.position.minimum_certification.abbreviation|default:ep.position.minimum_certification.name }}
                                  {% else %}
                                    <span class="text-muted">No min cert</span>
                                  {% endif %}
                                </div>
                              </div>
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="p-3">
                <div class="alert alert-warning mb-0">No event positions defined for this meet type and strategy.</div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
